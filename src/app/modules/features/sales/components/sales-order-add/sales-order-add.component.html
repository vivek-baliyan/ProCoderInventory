<!-- Body: Body -->
<div class="body d-flex py-3">
  <div class="container-xxl">
    <div class="row align-items-center">
      <div class="border-0 mb-4">
        <div
          class="card-header py-3 no-bg bg-transparent d-flex align-items-center px-0 justify-content-between border-bottom flex-wrap"
        >
          <h3 class="fw-bold mb-0">
            <i class="icofont-shopping-cart me-2"></i>
            New Sales Order
          </h3>
          <div class="d-flex gap-2">
            <button
              type="button"
              class="btn btn-outline-primary py-2 px-4"
              (click)="saveDraft()"
              [disabled]="isSaving || isLoading"
            >
              <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2" role="status"></span>
              <i *ngIf="!isSaving" class="icofont-save me-2"></i>
              Save as Draft
            </button>
            <button
              type="button"
              class="btn btn-primary py-2 px-4"
              (click)="saveAndSend()"
              [disabled]="isSaving || isLoading"
            >
              <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2" role="status"></span>
              <i *ngIf="!isSaving" class="icofont-send-mail me-2"></i>
              {{ isSaving ? 'Saving...' : 'Save and Send' }}
            </button>
            <button
              type="button"
              class="btn btn-secondary py-2 px-4"
              (click)="goBack()"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Row end  -->
    
    <form [formGroup]="salesOrderForm">
      <!-- Order Information -->
      <div class="row g-3 mb-3">
        <div class="col-12">
          <div class="card">
            <div class="card-header py-3 bg-transparent border-bottom-0">
              <h6 class="mb-0 fw-bold">Order Information</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Customer Name <span class="text-danger">*</span></label>
                  <app-autocomplete
                    placeholder="Select or add a customer"
                    [service]="customerAutocompleteService"
                    [showAddNew]="true"
                    addNewText="Add New Customer"
                    formControlName="customerId"
                    (itemSelected)="onCustomerSelected($event)"
                    (addNewClicked)="onAddNewCustomer($event)"
                  ></app-autocomplete>
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('customerId')" style="display: block;">
                    Please select a customer
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Sales Order# <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control"
                      formControlName="orderNumber"
                      [class.is-invalid]="isFieldInvalid('orderNumber')"
                      readonly
                    />
                    <button class="btn btn-outline-primary" type="button" (click)="generateOrderNumber()">
                      <i class="icofont-refresh"></i>
                    </button>
                  </div>
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('orderNumber')">
                    Order number is required
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Reference#</label>
                  <input
                    type="text"
                    class="form-control"
                    formControlName="referenceNumber"
                    placeholder="Enter reference number"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Sales Order Date <span class="text-danger">*</span></label>
                  <input
                    type="date"
                    class="form-control"
                    formControlName="orderDate"
                    [class.is-invalid]="isFieldInvalid('orderDate')"
                  />
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('orderDate')">
                    Please select order date
                  </div>
                  <small class="text-muted">
                    To create transaction dated before 01/07/2017, <a href="#" class="text-primary">click here</a>
                  </small>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Expected Shipment Date</label>
                  <input
                    type="date"
                    class="form-control"
                    formControlName="expectedShipmentDate"
                    placeholder="dd/MM/yyyy"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Shipping & Payment -->
      <div class="row g-3 mb-3">
        <div class="col-12">
          <div class="card">
            <div class="card-header py-3 bg-transparent border-bottom-0">
              <h6 class="mb-0 fw-bold">Shipping & Payment</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Payment Terms</label>
                  <select class="form-select" formControlName="paymentTerms">
                    <option *ngFor="let term of paymentTermsOptions" [value]="term.value">
                      {{ term.label }}
                    </option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Delivery Method</label>
                  <select class="form-select" formControlName="deliveryMethod">
                    <option value="">Select a delivery method or type to add</option>
                    <option *ngFor="let method of deliveryMethodOptions" [value]="method.value">
                      {{ method.label }}
                    </option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Salesperson</label>
                  <select class="form-select" formControlName="salespersonId">
                    <option value="">Select or Add Salesperson</option>
                    <option *ngFor="let salesperson of salespersonOptions" [value]="salesperson.value">
                      {{ salesperson.label }}
                    </option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Item Table -->
      <div class="row g-3 mb-3">
        <div class="col-12">
          <div class="card">
            <div class="card-header py-3 bg-transparent border-bottom-0 d-flex justify-content-between align-items-center">
              <h6 class="mb-0 fw-bold">Item Table</h6>
              <button type="button" class="btn btn-link text-primary p-0" style="color: #4A90E2 !important;">
                <i class="icofont-check-circled me-1"></i>
                Bulk Actions
              </button>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-borderless">
                  <thead>
                    <tr>
                      <th style="width: 40%;">ITEM DETAILS</th>
                      <th style="width: 10%;">QUANTITY</th>
                      <th style="width: 15%;">RATE</th>
                      <th style="width: 15%;">DISCOUNT</th>
                      <th style="width: 15%;">AMOUNT</th>
                      <th style="width: 5%;"></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let item of itemsFormArray.controls; let i = index" [formGroupName]="i">
                      <td>
                        <div class="d-flex align-items-center">
                          <div class="bg-light rounded me-3" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                            <i class="icofont-image text-muted"></i>
                          </div>
                          <div class="flex-grow-1">
                            <input
                              type="text"
                              class="form-control border-0 p-0 fw-medium"
                              formControlName="productName"
                              placeholder="Type or click to select an item."
                              [class.is-invalid]="isItemFieldInvalid(i, 'productName')"
                            />
                            <small class="text-muted d-block mt-1">Description or additional details</small>
                          </div>
                        </div>
                      </td>
                      <td>
                        <input
                          type="number"
                          class="form-control text-center"
                          formControlName="quantity"
                          min="0.01"
                          step="0.01"
                          [class.is-invalid]="isItemFieldInvalid(i, 'quantity')"
                        />
                      </td>
                      <td>
                        <input
                          type="number"
                          class="form-control text-end"
                          formControlName="unitPrice"
                          min="0"
                          step="0.01"
                          placeholder="0.00"
                          [class.is-invalid]="isItemFieldInvalid(i, 'unitPrice')"
                        />
                      </td>
                      <td>
                        <div class="input-group">
                          <input
                            type="number"
                            class="form-control text-end"
                            formControlName="discountPercentage"
                            min="0"
                            max="100"
                            step="0.01"
                            placeholder="0"
                          />
                          <span class="input-group-text">%</span>
                        </div>
                      </td>
                      <td class="text-end fw-medium">
                        {{ item.get('lineTotal')?.value || 0 | number:'1.2-2' }}
                      </td>
                      <td>
                        <div class="dropdown">
                          <button class="btn btn-sm" type="button" data-bs-toggle="dropdown">
                            <i class="icofont-ui-settings"></i>
                          </button>
                          <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" (click)="removeItem(i)"><i class="icofont-ui-delete text-danger me-2"></i>Delete</a></li>
                          </ul>
                        </div>
                      </td>
                    </tr>
                    <tr *ngIf="itemsFormArray.length === 0">
                      <td colspan="6" class="text-center py-4">
                        <div class="d-flex align-items-center justify-content-center">
                          <div class="bg-light rounded me-3" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                            <i class="icofont-image text-muted"></i>
                          </div>
                          <span class="text-muted">Type or click to select an item.</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <div class="mt-3">
                <button type="button" class="btn btn-link text-primary p-0" (click)="addItem()">
                  <i class="icofont-plus-circle me-2"></i>Add New Row
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="row g-3 mb-3">
        <div class="col-lg-8">
          <!-- Customer Notes -->
          <div class="card h-100">
            <div class="card-header py-3 bg-transparent border-bottom-0">
              <h6 class="mb-0 fw-bold">Customer Notes</h6>
            </div>
            <div class="card-body">
              <textarea
                class="form-control"
                formControlName="customerNotes"
                rows="4"
                placeholder="Enter any notes to be displayed in your transaction"
              ></textarea>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between mb-2">
                <span>Sub Total</span>
                <span class="fw-medium">{{ salesOrderForm.get('subtotal')?.value || 0 | number:'1.2-2' }}</span>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span>Shipping Charges</span>
                <div class="d-flex align-items-center">
                  <input
                    type="number"
                    class="form-control form-control-sm text-end me-2"
                    formControlName="shippingCharges"
                    min="0"
                    step="0.01"
                    style="width: 80px;"
                    (input)="onShippingOrAdjustmentChange()"
                  />
                  <i class="icofont-question-circle text-muted"></i>
                </div>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="d-flex align-items-center">
                  <input
                    type="text"
                    class="form-control form-control-sm me-2"
                    placeholder="Adjustment"
                    style="width: 100px;"
                  />
                </div>
                <div class="d-flex align-items-center">
                  <input
                    type="number"
                    class="form-control form-control-sm text-end me-2"
                    formControlName="adjustment"
                    step="0.01"
                    style="width: 80px;"
                    (input)="onShippingOrAdjustmentChange()"
                  />
                  <i class="icofont-question-circle text-muted"></i>
                </div>
              </div>
              <div class="d-flex justify-content-between mb-3">
                <span>Round Off</span>
                <span class="fw-medium">0.000</span>
              </div>
              <hr>
              <div class="d-flex justify-content-between fs-5 fw-bold">
                <span>Total ( Rs. )</span>
                <span>{{ salesOrderForm.get('totalAmount')?.value || 0 | number:'1.2-2' }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Terms & Conditions and Attachments -->
      <div class="row g-3 mb-3">
        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header py-3 bg-transparent border-bottom-0">
              <h6 class="mb-0 fw-bold">Terms & Conditions</h6>
            </div>
            <div class="card-body">
              <textarea
                class="form-control"
                formControlName="termsAndConditions"
                rows="6"
                placeholder="Enter the terms and conditions of your business to be displayed in your transaction"
              ></textarea>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header py-3 bg-transparent border-bottom-0">
              <h6 class="mb-0 fw-bold">Attach File(s) to Sales Order</h6>
            </div>
            <div class="card-body">
              <app-document-upload
                [documents]="uploadedDocuments"
                (documentsChange)="onDocumentsChange($event)"
                [maxFiles]="10"
                [maxFileSize]="5242880"
                acceptedTypes=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                title="">
              </app-document-upload>
              <small class="text-muted d-block mt-2">
                You can upload a maximum of 10 files, 5MB each
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- Additional Fields Info -->
      <div class="row g-3 mb-3">
        <div class="col-12">
          <p class="text-muted mb-0">
            <strong>Additional Fields:</strong> Add custom fields to your sales orders by going to 
            <span class="text-primary">Settings ➤ Sales ➤ Sales orders ➤ Field Customization</span>.
          </p>
        </div>
      </div>

    </form>
    
    <!-- Footer Summary -->
    <div class="row">
      <div class="col-12">
        <div class="d-flex justify-content-end align-items-center">
          <span class="me-4">Total Amount: <strong>Rs. {{ salesOrderForm.get('totalAmount')?.value || 0 | number:'1.2-2' }}</strong></span>
          <span>Total Quantity: <strong>{{ salesOrderForm.get('totalQuantity')?.value || 0 }}</strong></span>
        </div>
      </div>
    </div>
    <!-- Row end  -->
  </div>
</div>
